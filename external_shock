globals [
  percent-similar  ; on the average, what percent of a turtle's neighbors
                   ; are the same color as that turtle?
  percent-unhappy  ; what percent of the turtles are unhappy?
  pandemic-timer  ; monitors ticks until the next pandemic
  price-obs        ; monitors mean patch prices with balcony
  price-obs-no      ; montors mean patch prices without balcony

]

turtles-own [
  happy?           ; for each turtle, indicates whether at least %-similar-wanted percent of
                   ;   that turtle's neighbors are the same color as the turtle
  similar-nearby   ; how many neighboring patches have a turtle with my color?
  other-nearby     ; how many have a turtle of another color?
  total-nearby     ; sum of previous two variables

]

patches-own [
  balcony         ; whether the patch has a balcony
  price            ; the price of patch

]

to setup
  clear-all
  reset-ticks
  ; create turtles on random patches.
  ask patches [
  set balcony (random 2 = 1) ; 50% chance of having balcony
  set price random 50 ; random price between 0 and 50
    set pcolor white
    if random 100 < density [   ; set the occupancy density
      sprout 1 [
        ; 105 is the color number for "blue"
        ; 27 is the color number for "orange"
        set color one-of [105 27]
        set size 1
        
      ]
    ]
  ]
  update-turtles
  update-globals
  set pandemic-timer "peacetime"  ; set the initial pandemic timer to 0
end

; run the model for one tick
to go
  if all? turtles [ happy? ] [ stop ]
  move-unhappy-turtles
  update-turtles
  update-globals
  ifelse ticks mod 5 = 0 [
    set pandemic-timer "pandemic"     ; "pandemic" occurs every 5 ticks
  ] [set pandemic-timer "peacetime"]   ; otherwise no pandemic

  tick
end

; unhappy turtles try a new spot
to move-unhappy-turtles
  ask turtles with [ not happy? ]
    [ find-new-spot ]
end

to move-randomly
  rt random-float 360
    fd random-float 10
    if any? other turtles-here [ find-new-spot ] ; keep going until we find an unoccupied patch
    move-to patch-here  ; move to center of patch

end

to find-new-spot
  if price >= 50 [
      move-to min-one-of patches with-min [price] [price] ; tries to move to patch with minimum price value
    ] 
     
    move-randomly
  
end




to update-turtles
  ask turtles [
    ; in next two lines, we use "neighbors" to test the eight patches
    ; surrounding the current patch
    set similar-nearby count (turtles-on neighbors)  with [ color = [ color ] of myself ]
    set other-nearby count (turtles-on neighbors) with [ color != [ color ] of myself ]
    set total-nearby similar-nearby + other-nearby
    set happy? similar-nearby >= (%-similar-wanted * total-nearby / 100)
    ; add visualization here
    if visualization = "old" [ set shape "default" set size 1.3 ]
    if visualization = "square-x" [
      ifelse happy? [ set shape "square" ] [ set shape "X" ]
    ]
    if price <= 25 and balcony [
      ; if the apartment has a balcony and the price is not already maxed out
      set price price + 5  ; increase the price by 10
    ]
  ]
end


to update-globals
  

  if pandemic-timer = "pandemic" [
    ask patches [
      ifelse balcony
        [ set price (price + 5) ]
        [ set price (price - 1) ]
    ]
  ]

  let similar-neighbors sum [ similar-nearby ] of turtles
  let total-neighbors sum [ total-nearby ] of turtles
  set percent-similar (similar-neighbors / total-neighbors) * 100
  set percent-unhappy (count turtles with [ not happy? ]) / (count turtles) * 100
  let total-price mean [price] of patches with [balcony]
  set price-obs total-price ; monitors mean price of patches with balcony
  let total-price-no mean [price] of patches with [not balcony]; without balcony
  set price-obs-no total-price-no ; monitors mean price of patches without balcony
end



; Copyright 1997 Uri Wilensky.
; See Info tab for full copyright and license.
